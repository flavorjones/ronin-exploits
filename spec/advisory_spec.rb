require 'spec_helper'
require 'ronin/advisory'

describe Advisory do
  let(:publisher) { 'CVE' }
  let(:year)      { 2011  }
  let(:number)    { 1234  }

  subject do
    described_class.new(
      :publisher => publisher,
      :year      => year,
      :number    => number
    )
  end

  describe "split" do
    subject { described_class }

    it "should split NAME-YEAR-NUMBER identifier Strings" do
      components = subject.split("#{publisher}-#{year}-#{number}")

      components.should == [publisher, year, number]
    end

    it "should split NAME-NUMBER identifier Strings" do
      components = subject.split("#{publisher}-#{number}")

      components.should == [publisher, nil, number]
    end

    it "should return nil for unrecognized formats" do
      subject.split("#{publisher}_#{year}_#{number}").should be_nil
    end
  end

  describe "parse" do
    subject { described_class }

    it "should parse NAME-YEAR-NUMBER identifier Strings" do
      advisory = subject.parse("#{publisher}-#{year}-#{number}")

      advisory.publisher.should == publisher
      advisory.year.should      == year
      advisory.number.should    == number
    end

    it "should parse NAME-NUMBER identifier Strings" do
      advisory = subject.parse("#{publisher}-#{number}")

      advisory.publisher.should == publisher
      advisory.year.should      be_nil
      advisory.number.should    == number
    end
  end

  describe "[]" do
    subject { described_class }

    let(:advisory1) { "#{publisher}-#{year}-#{number}" }
    let(:advisory2) { "#{publisher}-#{number}"       }

    before(:all) do
      described_class.parse(advisory1).save
      described_class.parse(advisory2).save
    end

    it "should lookup NAME-YEAR-NUMBER identifier Strings" do
      advisory = subject[advisory1]

      advisory.publisher.should == publisher
      advisory.year.should      == year
      advisory.number.should    == number
    end

    it "should lookup NAME-NUMBER identifier Strings" do
      advisory = subject[advisory2]

      advisory.publisher.should == publisher
      advisory.year.should      be_nil
      advisory.number.should    == number
    end
  end

  describe "#url" do
    it "should return a URL for CVE advisories" do
      advisory = described_class.new(
        :publisher => 'CVE',
        :year      => year,
        :number    => number
      )

      advisory.url.should == "https://web.nvd.nist.gov/view/vuln/detail?vulnId=#{year}-#{number}"
    end

    it "should return a URL for OSVDB advisories" do
      advisory = described_class.new(
        :publisher => 'OSVDB',
        :number    => number
      )

      advisory.url.should == "https://osvdb.org/show/osvdb/#{number}"
    end

    it "should return nil for unknown publishers" do
      advisory = described_class.new(
        :publisher => 'FOO',
        :year      => year,
        :number    => number
      )

      advisory.url.should be_nil
    end
  end

  describe "#to_s" do
    it "should join the publisher and number" do
      subject.to_s.should == "#{publisher}-#{year}-#{number}"
    end
  end

  describe "#to_ary" do
    it "should splat the publisher and number" do
      advisory_publisher, advisory_year, advisory_number = subject

      advisory_publisher.should == publisher
      advisory_year.should      == year
      advisory_number.should    == number
    end
  end

  describe "#inspect" do
    it "should include the class, publisher and number" do
      subject.inspect.should == "#<#{described_class}: #{publisher}-#{year}-#{number}>"
    end
  end
end
