require 'spec_helper'
require 'ronin/exploits/http'

describe Exploits::HTTP do
  subject { described_class.new(:name => 'example_httpd') }

  it "should initialize all parameters by default" do
    subject.params.should_not be_empty
  end

  its(:default_port) { should == 80 }

  describe "#url_for" do
    let(:host)  { 'www.example.com' }
    let(:port)  { 8080 }
    let(:path)  { '/path' }
    let(:query) { 'q=1' }
    let(:query_params) { {'x' => '1', 'y' => '2'} }

    subject { described_class.new(:host => host, :port => port) }

    it "should use the host parameter" do
      subject.url_for(path).host.should == host
    end

    context "when host is not set" do
      subject { described_class.new }

      it "should raise a MissingParam exception" do
        lambda {
          subject.url_for(path)
        }.should raise_error(Parameters::MissingParam)
      end
    end

    it "should use the port parameter" do
      subject.url_for(path).port.should == port
    end

    it "should include the path" do
      subject.url_for(path).path.should == path
    end

    it "should extract the query-string from the path" do
      url = subject.url_for("#{path}?#{query}")
        
      url.path.should  == path
      url.query.should == query
    end

    it "should merge query-params into the query string" do
      url = subject.url_for("#{path}?#{query}",query_params)
      
      url.query.should include(query)
      url.query_params['x'].should == query_params['x']
      url.query_params['y'].should == query_params['y']
    end

    context "when url_prefix is set" do
      let(:prefix) { '/prefix' }

      it "should prefix the path" do
        exploit = described_class.new(
          :host       => host,
          :url_prefix => prefix
        )

        exploit.url_for(path).path.should == prefix + path
      end

      it "should ensure the path always begins with a '/'" do
        exploit = described_class.new(
          :host       => host,
          :url_prefix => prefix[1..-1]
        )

        exploit.url_for(path).path.should == prefix + path
      end
    end
  end
end
