require 'spec_helper'

require 'ronin/exploits/sqli'

describe Exploits::SQLi do
  let(:host)                { 'testasp.vulnweb.com' }
  let(:path)                { '/showthread.asp' }
  let(:query_param)         { 'id' }
  let(:query_param_value)   { '2' }
  let(:query)               { "#{query_param}=#{query_param_value}" }

  let(:exploit) do
    described_class.new(
      host:            host,
      url_path:        path,
      url_query:       query,
      url_query_param: {name: query_param}
    )
  end

  subject { exploit }

  context "defaults" do
    describe "#quotes" do
      subject { super().quotes }

      it { expect(subject).to eq('single') }
    end

    describe "#terminate" do
      subject { super().terminate }

      it { expect(subject).to be(false) }
    end

    describe "#case" do
      subject { super().case }

      it { expect(subject).to be_nil }
    end

    describe "#space" do
      subject { super().space }

      it { expect(subject).to be_nil }
    end
  end

  describe "#place_holder" do
    it "should return an Integer" do
      expect(subject.place_holder).to eq(query_param_value.to_i)
    end

    context "when escape is 'decimal'" do
      before { subject.escape = 'decimal' }

      it "should return a Float" do
        expect(subject.place_holder).to eq(query_param_value.to_f)
      end
    end

    context "when escape is 'string'" do
      before { subject.escape = 'string' }

      it "should return a String" do
        expect(subject.place_holder).to eq(query_param_value)
      end
    end

    context "when escape is 'list'" do
      before { subject.escape = 'list' }

      context "and url_query_param_value is an integer value" do
        let(:query_param_value) { '2' }

        it "should return an Array containing an Integer" do
          expect(subject.place_holder).to eq([query_param_value.to_i])
        end
      end

      context "and url_query_param_value is a decimal value" do
        let(:query_param_value) { '2.0' }

        it "should return an Array containing a Float" do
          expect(subject.place_holder).to eq([query_param_value.to_f])
        end
      end

      context "and url_query_param_value is a string value" do
        let(:query_param_value) { 'A' }

        it "should return an Array containing a String" do
          expect(subject.place_holder).to eq([query_param_value])
        end
      end
    end

    context "when escape is 'column'" do
      before { subject.escape = 'column' }

      it "should return a Symbol" do
        expect(subject.place_holder).to eq(query_param_value.to_sym)
      end
    end
  end

  describe "#sqli" do
    subject { exploit.sqli }

    it "should set #escape" do
      expect(subject.escape).to eq(exploit.escape.to_sym)
    end
  end

  describe "#exploit_url" do
    context "when passed a object that responds to #to_sql" do
      let(:sql)     { subject.sqli.or { 1 == 1 } }
      let(:raw_sql) { sql.to_sql }

      it "should set the query_param to the formatted SQL" do
        uri = subject.exploit_url(sql)

        expect(uri.query_params[query_param]).to eq(raw_sql)
      end

      context "when space is set" do
        before { subject.space = :comment }

        let(:raw_sql) { sql.to_sql(space: '/**/') }

        it "should format the SQL with the custom spaces" do
          uri = subject.exploit_url(sql)

          expect(uri.query_params[query_param]).to eq(raw_sql)
        end
      end

      context "when terminate is true" do
        before { subject.terminate = true }

        let(:raw_sql) { sql.to_sql(terminate: true) }

        it "should terminate the SQL" do
          uri = subject.exploit_url(sql)

          expect(uri.query_params[query_param]).to eq(raw_sql)
        end
      end
    end

    context "otherwise" do
      let(:sql)     { 1 }
      let(:raw_sql) { '1' }

      it "should convert the SQL to a String" do
        uri = subject.exploit_url(sql)

        expect(uri.query_params[query_param]).to eq(raw_sql)
      end
    end
  end

  describe "#test_quotes", network: true do
    it "should test quote-marks for 500 responses" do
      expect(subject.test_quotes).to be_true
    end
  end

  describe "#test_and_false", network: true do
    it "should test \"AND 1=0\" for responses with less data" do
      expect(subject.test_and_false).to be_true
    end
  end

  describe "#test_or_true", network: true do
    it "should test \"OR 1=1\" for responses with more data" do
      expect(subject.test_or_true).to be_true
    end
  end

  describe "#vulnerable?", network: true do
    it "should determine if SQL can be injected" do
      expect(subject).to be_vulnerable
    end
  end
end
