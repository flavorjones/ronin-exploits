require 'spec_helper'
require 'ronin/exploits/target'

describe Exploits::Target do
  subject do
    described_class.new(
      params: {var: 1, test: 'hello'},
      exploit: {
        name: 'exploit with targets'
      }
    )
  end

  it "should not have an Arch by default" do
    expect(subject.arch).to be_nil
  end

  it "should not have an OS by default" do
    expect(subject.os).to be_nil
  end

  it "should not have targeted software by default" do
    expect(subject.software).to be_nil
  end

  it "should have params" do
    expect(subject).to be_param(:var)
    expect(subject).to be_param(:test)
  end

  describe "params" do
    it "should contain target params" do
      expect(subject.params[:var]).to eq(1)
      expect(subject.params[:test]).to eq('hello')
    end

    it "should provide Hash like access to target params" do
      expect(subject[:var]).to eq(1)
      expect(subject[:test]).to eq('hello')
    end

    it "should be able to set params like a Hash" do
      subject[:var] = 2

      expect(subject[:var]).to eq(2)
    end

    it "should provide OStruct like access to target params" do
      expect(subject.var).to eq(1)
      expect(subject.test).to eq('hello')
    end

    it "should be able to set params like an OStruct" do
      subject.var = 2

      expect(subject.var).to eq(2)
    end

    it "should be able to serialize and deserialize it's target params" do
      subject.save
      target = Exploits::Target.get(subject.id)

      expect(target.params[:var]).to eq(1)
      expect(target.params[:test]).to eq('hello')
    end

    it "should not raise TargetDataMissing when setting new params" do
      expect {
        subject.bla = 'yes'
      }.not_to raise_error

      expect(subject.bla).to eq('yes')
    end

    it "should raise TargetDataMissing when accessing non-existant params" do
      expect {
        subject.bla
      }.to raise_error(Exploits::TargetDataMissing)
    end
  end
end
