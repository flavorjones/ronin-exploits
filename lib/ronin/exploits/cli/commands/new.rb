#
# ronin-exploits - A Ruby library for ronin-rb that provides exploitation and
# payload crafting functionality.
#
# Copyright (c) 2007-2022 Hal Brodigan (postmodern.mod3 at gmail.com)
#
# This file is part of ronin-exploits.
#
# ronin-exploits is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# ronin-exploits is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with ronin-exploits.  If not, see <https://www.gnu.org/licenses/>.
#

require 'ronin/exploits/cli/command'
require 'ronin/exploits/root'
require 'ronin/payloads/cli/generator/payload_types'
require 'ronin/core/cli/options/values/arches'
require 'ronin/core/cli/options/values/oses'
require 'ronin/core/cli/generator'
require 'ronin/core/git'

require 'command_kit/inflector'

module Ronin
  module Exploits
    class CLI
      module Commands
        #
        # Creates a new exploit file.
        #
        # ## Usage
        #
        #     ronin-exploit new [options] FILE
        #
        # ## Options
        # 
        #     -t exploit|heap_overflow|stack_overflow|web|lfi|rfi|sqli,
        #         --type                       The type for the new exploit
        #     -a, --author NAME                The name of the author (Default: Postmodern)
        #     -e, --author-email EMAIL         The email address of the author (Default: postmodern.mod3@gmail.com)
        #     -s, --summary TEXT               One sentence summary for the exploit
        #     -d, --description TEXT           Longer description for the exploit
        #     -I CVE-YYYY-NNNN|GHSA-XXXXX|..., Add the advisory ID to the exploit
        #         --advisory-id
        #     -R, --reference URL              Adds a reference to the exploit
        #     -P payload|asm|shellcode|c|shell|powershell|html|javascript|typpescript|java|sql|php|nodejs,
        #         --has-payload                The payload type the exploit uses
        #     -N remote_tcp|remote_udp|http,   The networking mixin to use
        #         --networking
        #     -A x86|x86-64|amd64|ia64|ppc|ppc64|arm|armbe|arm64|arm64be|mips|mipsle|mips64|mips64le,
        #         --arch                       The architecture to target
        #     -O linux|macos|windows|freebsd|openbsd|netbsd,
        #         --os                         The Operating System (OS) to target
        #         --os-version VERSION         The OS version to target
        #     -S, --software NAME              The software to target
        #     -V, --software-version ARCH      The software version to target
        #     -h, --help                       Print help information
        #
        # ## Arguments
        #
        #     FILE                             The path to the new exploit file.
        #
        class New < Command

          include Core::CLI::Generator
          include Payloads::CLI::Generator

          EXPLOIT_TYPES = {
            exploit: {
              file:  'exploit',
              class: 'Exploit'
            },

            heap_overflow: {
              file:  'heap_overflow',
              class: 'HeapOverflow'
            },

            stack_overflow: {
              file:  'stack_overflow',
              class: 'StackOverflow'
            },

            web: {
              file:  'web',
              class: 'Web'
            },

            lfi: {
              file:  'lfi',
              class: 'LFI'
            },

            rfi: {
              file:  'rfi',
              class: 'RFI'
            },

            sqli: {
              file:  'sqli',
              class: 'SQLi'
            },
          }

          NETWORKING_TYPES = {
            remote_tcp: {
              file:   'remote_tcp',
              module: 'RemoteTCP'
            },

            remote_udp: {
              file:   'remote_udp',
              module: 'RemoteUDP'
            },

            http: {
              file:   'http',
              module: 'HTTP'
            }
          }

          template_dir File.join(ROOT,'data','templates')

          usage '[options] FILE'

          option :type, short: '-t',
                        value: {
                          type: EXPLOIT_TYPES.keys.compact
                        },
                        desc: 'The type for the new exploit' do |type|
                          @exploit_type = EXPLOIT_TYPES.fetch(type)
                        end

          option :author, short: '-a',
                          value: {
                            type:  String,
                            usage: 'NAME',
                            default: Core::Git.user_name || ENV['USERNAME']
                          },
                          desc: 'The name of the author'

          option :author_email, short: '-e',
                                value: {
                                  type:  String,
                                  usage: 'EMAIL',
                                  default: Core::Git.user_email
                                },
                                desc: 'The email address of the author'

          option :summary, short: '-s',
                           value: {
                             type: String,
                             usage: 'TEXT'
                           },
                           desc: 'One sentence summary for the exploit' do |text|
                             @summary = text
                           end

          option :description, short: '-d',
                               value: {
                                 type: String,
                                 usage: 'TEXT'
                               },
                               desc: 'Longer description for the exploit' do |text|
                                 @description = text
                               end

          option :advisory_id, short: '-I',
                               value: {
                                 type:  String,
                                 usage: 'CVE-YYYY-NNNN|GHSA-XXXXX|...'
                               },
                               desc: 'Add the advisory ID to the exploit' do |id|
                                 @advisories << id
                               end

          option :reference, short: '-R',
                             value: {
                               type: String,
                               usage: 'URL'
                             },
                             desc: 'Adds a reference to the exploit' do |url|
                               @references << url
                             end

          option :has_payload, short: '-P',
                               value: {type: PAYLOAD_TYPES.keys},
                               desc: 'The payload type the exploit uses' do |type|
                                 @has_payload = PAYLOAD_TYPES.fetch(type)
                               end

          option :networking, short: '-N',
                              value: {
                                type: NETWORKING_TYPES.keys
                              },
                              desc: 'The networking mixin to use' do |type|
                                @networking       = type
                                @networking_mixin = NETWORKING_TYPES.fetch(type)
                              end

          option :arch, short: '-A',
                        value: {
                          type: Core::CLI::Options::Values::ARCHES
                        },
                        desc: 'The architecture to target' do |arch|
                          @target ||= {}
                          @target[:arch] = arch
                        end

          option :os, short: '-O',
                      value: {
                        type: Core::CLI::Options::Values::OSES
                      },
                      desc: 'The Operating System (OS) to target' do |os|
                        @target ||= {}
                        @target[:os] = os
                      end

          option :os_version, value: {
                                type:  String,
                                usage: 'VERSION'
                              },
                              desc: 'The OS version to target' do |ver|
                                @target ||= {}
                                @target[:os_version] = ver
                              end

          option :software, short: '-S',
                            value: {
                              type:  String,
                              usage: 'NAME'
                            },
                            desc: 'The software to target' do |name|
                              @target ||= {}
                              @target[:software] = name
                            end

          option :software_version, short: '-V',
                                    value: {
                                      type:  String,
                                      usage: 'ARCH'
                                    },
                                    desc: 'The software version to target' do |ver|
                                      @target ||= {}
                                      @target[:version] = ver
                                    end

          argument :file, desc: 'The path to the new exploit file'

          description 'Creates a new exploit file'

          man_page 'ronin-exploits-new.1'

          #
          # Initialies the `ronin-exploits new` command.
          #
          # @param [Hash{Symbol => Object}] kwargs
          #   Additional keyword arguments.
          #
          def initialize(**kwargs)
            super(**kwargs)

            @exploit_type = EXPLOIT_TYPES.fetch(:exploit)
            @advisories   = []
            @references   = []
          end

          #
          # Runs the `ronin-exploits new` command.
          #
          # @param [String] file
          #   The path to the new exploit file.
          #
          def run(file)
            @file_name  = File.basename(file,File.extname(file))
            @class_name = CommandKit::Inflector.camelize(@file_name)

            @author_name  = options[:author]
            @author_email = options[:author_email]

            erb "exploit.rb.erb", file
            chmod '+x', file
          end

          #
          # Formats a Hash into Ruby keyword arguments.
          #
          # @param [Hash{Symbol => Object}] kwargs
          #
          # @return [String]
          #
          def format_kwargs(kwargs)
            args = []

            kwargs.each do |key,value|
              args << "#{key}: #{value.inspect}"
            end

            return args.join(', ')
          end

        end
      end
    end
  end
end
